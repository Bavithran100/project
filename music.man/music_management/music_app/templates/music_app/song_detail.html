{% extends 'music_app/base.html' %}

{% block title %}{{ song.title }} - Music Player{% endblock %}

{% block extra_css %}
<style>
    .song-detail {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 2rem;
        background: var(--spotify-dark-gray);
        border-radius: 8px;
        padding: 2rem;
        margin-top: 2rem;
    }

    .cover-image {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .cover-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .song-info {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .song-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--spotify-white);
    }

    .song-artist {
        font-size: 1.5rem;
        color: var(--spotify-light-gray);
    }

    .song-album {
        font-size: 1.2rem;
        color: var(--spotify-light-gray);
    }

    .song-release-date {
        font-size: 1rem;
        color: var(--spotify-light-gray);
    }

    .favorite-button {
        background: none;
        border: none;
        color: var(--spotify-light-gray);
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 0.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
    }

    .favorite-button:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .favorite-button.active {
        color: var(--spotify-green);
    }

    .favorite-button.active:hover {
        color: #1ed760;
    }

    .actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .action-button {
        padding: 0.75rem 1.5rem;
        border-radius: 24px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .play-button {
        background: var(--spotify-green);
        color: var(--spotify-black);
        width: 48px;
        height: 48px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .play-button:hover {
        background: #1ed760;
        transform: scale(1.02);
    }

    .play-button i {
        font-size: 1.2rem;
    }

    .edit-button {
        background: rgba(255, 255, 255, 0.1);
        color: var(--spotify-white);
    }

    .edit-button:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    @media (max-width: 768px) {
        .song-detail {
            grid-template-columns: 1fr;
        }

        .cover-image {
            max-width: 300px;
            margin: 0 auto;
        }

        .song-title {
            font-size: 2rem;
        }

        .song-artist {
            font-size: 1.2rem;
        }
    }

    .now-playing-bar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: #282828;
        padding: 1rem;
        z-index: 1000;
    }

    .now-playing-grid {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        align-items: center;
        gap: 1rem;
        max-width: 1500px;
        margin: 0 auto;
    }

    .control-button {
        background: none;
        border: none;
        color: #b3b3b3;
        cursor: pointer;
        transition: all 0.2s;
        padding: 0.5rem;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .control-button:hover {
        color: #fff;
        transform: scale(1.1);
    }

    .control-button.primary {
        background: #fff;
        color: #000;
    }

    .control-button.primary:hover {
        transform: scale(1.1);
        background: #fff;
    }

    .progress-bar {
        width: 100%;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #b3b3b3;
        font-size: 0.8rem;
        padding: 0 1rem;
    }

    .progress-slider {
        flex: 1;
        -webkit-appearance: none;
        appearance: none;
        height: 4px;
        border-radius: 2px;
        background: #535353;
        outline: none;
        cursor: pointer;
    }

    .progress-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s;
    }

    .progress-slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
    }

    .volume-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: flex-end;
        padding-right: 1rem;
    }

    .volume-slider {
        width: 100px;
        -webkit-appearance: none;
        appearance: none;
        height: 4px;
        border-radius: 2px;
        background: #535353;
        outline: none;
        cursor: pointer;
    }

    .volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s;
    }

    .volume-slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
    }

    .image-placeholder {
        background: var(--spotify-dark-gray);
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .image-error {
        color: var(--spotify-light-gray);
        font-size: 2rem;
    }

    .now-playing-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .now-playing-cover img.hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="song-detail">
    <div class="cover-image">
        {% if song.cover_image %}
            <img src="{{ song.cover_image.url }}" 
                 alt="{{ song.title }} cover"
                 onload="handleImageLoad(this)">
        {% else %}
            <div class="image-placeholder">
                <i class="fas fa-music image-error"></i>
            </div>
        {% endif %}
    </div>
    
    <div class="song-info">
        <h1 class="song-title">{{ song.title }}</h1>
        <p class="song-artist">{{ song.artist }}</p>
        <p class="song-album">{{ song.album }}</p>
        <p class="song-release-date">Released: {{ song.release_date }}</p>
        
        <div class="actions">
            {% if song.audio_file %}
            <button class="action-button play-button" 
                    data-song-url="{{ song.audio_file.url }}"
                    onclick="playSong('{{ song.audio_file.url }}', '{{ song.title }}', '{{ song.artist }}', '{% if song.cover_image %}{{ song.cover_image.url }}{% endif %}')" 
                    title="Play">
                <i class="fas fa-play"></i>
            </button>
            {% else %}
            <button class="action-button play-button" disabled style="opacity: 0.5; cursor: not-allowed;" title="No audio available">
                <i class="fas fa-play"></i>
            </button>
            {% endif %}
            <a href="#" class="action-button edit-button" title="Edit">
                <i class="fas fa-edit"></i>
            </a>
            <form method="post" action="{% url 'toggle_favorite' song.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="favorite-button {% if is_favorite %}active{% endif %}" title="{% if is_favorite %}Remove from favorites{% else %}Add to favorites{% endif %}">
                    <i class="fas fa-heart"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<div class="now-playing-bar">
    <div class="now-playing-grid">
        <div class="now-playing-info">
            <div class="now-playing-cover">
                <img src="" alt="Now Playing">
            </div>
            <div class="now-playing-meta">
                <h4 class="now-playing-title"></h4>
                <p class="now-playing-artist"></p>
            </div>
        </div>

        <div class="playback-controls">
            <div class="control-buttons">
                <button class="control-button" onclick="previousSong()" title="Previous">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="control-button" onclick="seekBackward()" title="Seek Backward">
                    <i class="fas fa-backward"></i>
                </button>
                <button class="control-button primary" onclick="togglePlayPause()" title="Play/Pause">
                    <i class="fas fa-play"></i>
                </button>
                <button class="control-button" onclick="seekForward()" title="Seek Forward">
                    <i class="fas fa-forward"></i>
                </button>
                <button class="control-button" onclick="nextSong()" title="Next">
                    <i class="fas fa-step-forward"></i>
                </button>
            </div>
            <div class="progress-bar">
                <span id="currentTime">0:00</span>
                <input type="range" class="progress-slider" min="0" max="100" value="0" id="progressBar">
                <span id="duration">0:00</span>
            </div>
        </div>

        <div class="volume-controls">
            <button class="control-button" onclick="toggleMute()" title="Mute">
                <i class="fas fa-volume-up" id="volumeIcon"></i>
            </button>
            <input type="range" class="volume-slider" min="0" max="100" value="100" id="volumeControl">
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const favoriteButton = document.querySelector('.favorite-button');
    
    favoriteButton.addEventListener('click', function(e) {
        this.classList.toggle('active');
    });

    const playButton = document.querySelector('.action-button.play-button');
    if (playButton) {
        playButton.innerHTML = '<i class="fas fa-play"></i>';
    }

    const progressBar = document.getElementById('progressBar');
    const currentTimeDisplay = document.getElementById('currentTime');
    const durationDisplay = document.getElementById('duration');

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        seconds = Math.floor(seconds % 60);
        return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    audioPlayer.addEventListener('timeupdate', () => {
        if (!audioPlayer.duration) return;
        const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressBar.value = progress;
        currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
    });

    audioPlayer.addEventListener('loadedmetadata', () => {
        durationDisplay.textContent = formatTime(audioPlayer.duration);
    });

    progressBar.addEventListener('input', () => {
        if (!audioPlayer.duration) return;
        const time = (progressBar.value / 100) * audioPlayer.duration;
        audioPlayer.currentTime = time;
    });

    function seekForward() {
        if (!audioPlayer.duration) return;
        audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 10, audioPlayer.duration);
    }

    function seekBackward() {
        if (!audioPlayer.duration) return;
        audioPlayer.currentTime = Math.max(audioPlayer.currentTime - 10, 0);
    }

    const volumeControl = document.getElementById('volumeControl');
    const volumeIcon = document.getElementById('volumeIcon');
    let lastVolume = 1;

    volumeControl.addEventListener('input', () => {
        const volume = volumeControl.value / 100;
        audioPlayer.volume = volume;
        updateVolumeIcon(volume);
        if (volume > 0) lastVolume = volume;
    });

    function toggleMute() {
        if (audioPlayer.volume > 0) {
            audioPlayer.volume = 0;
            volumeControl.value = 0;
        } else {
            audioPlayer.volume = lastVolume;
            volumeControl.value = lastVolume * 100;
        }
        updateVolumeIcon(audioPlayer.volume);
    }

    function updateVolumeIcon(volume) {
        if (volume === 0) {
            volumeIcon.className = 'fas fa-volume-mute';
        } else if (volume < 0.5) {
            volumeIcon.className = 'fas fa-volume-down';
        } else {
            volumeIcon.className = 'fas fa-volume-up';
        }
    }
</script>
{% endblock %} 